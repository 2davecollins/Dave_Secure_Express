<h1>Stores Located Near You</h1>
<br />

<br />
<div id="mapid" style="width: 1000px; height: 500px;"></div>
<br />
<a class="btn btn-info" href="/location/add_location" role="button">Admin</a>
<div id="loc"></div>

<script>
	var x = document.getElementById('loc');
	function getLocation() {
		console.log('get geolocation');
		if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(showPosition);
		} else {
			x.innerHTML = 'Geolocation is not supported by this browser.';
		}
	}

	function showPosition(position) {
		console.log('showing position');
		x.innerHTML = 'Latitude: ' + position.coords.latitude + '<br>Longitude: ' + position.coords.longitude;
	}
	getLocation();
	let m = [];
	
	fetch('/api/loc')
		.then(response => {
			return response.json();
		})
		.then(data => {
			if (data.length > 0) {
				data.forEach(m => {
					addMarker(m);
				});
			}
		});
	const home = [53.319517, -6.3091073];
	const center = [53.291, -6.4382];
	const msg = '<b>My Home</b><br />Starting Point';
	const dist = 2000;
	const distmsg = '2k';

	const mymap = L.map('mapid', {
		center: home,
		minZoom: 3,
		zoom: 13,
		dragging: false,
		doubleClickZoom: false,
		scrollWheelZoom: false,
	});

	
	

	addHomeMarker(home, msg);	
	//createMap(center);
	createSecureMap(center);
	addCircle(home, dist, distmsg);

	function createMap(cntr) {
		const osm = new L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
			attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
		});
		osm.addTo(mymap);		
	}

	function createSecureMap(cntr){

		const osms = new L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
		}).addTo(mymap);
	}

	function addCircle(ctnr, dist, msg) {
		L.circle(ctnr, dist, {
			color: 'red',
			fillColor: '#f03',
			fillOpacity: 0.05,
		})
			.addTo(mymap)
			.bindPopup(msg);
	}

	function addMarker(m) {
		L.marker(m).addTo(mymap);
	}

	function addHomeMarker(m, msg) {
		const greenIcon = new L.Icon({
			iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
			shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
			iconSize: [25, 41],
			iconAnchor: [12, 41],
			popupAnchor: [1, -34],
			shadowSize: [41, 41],
		});
		L.marker(m, { icon: greenIcon })
			.addTo(mymap)
			.bindPopup(msg)
			.openPopup();
	}
</script>
